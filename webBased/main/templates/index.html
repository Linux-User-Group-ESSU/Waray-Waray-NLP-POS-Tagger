<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="/static/jquery.min.js"></script>
    <script src="/static/toastr.min.js" defer></script>
    <script src="/static/select2.min.js"></script>
    <link rel="stylesheet" href="/static/toastr.min.css">
    <link rel="stylesheet" href="/static/select2.min.css">
    <style>
        body {
            background-color: antiquewhite;
        }

        .actions div{
            display: inline-block;
            padding: 0% 1%;
        }
        
        .title {
            border-bottom: 1px solid black;
            padding: 1%;
        }
        
        .pos-tag {
            padding: 1% 1%;
        }
        
        .pos-data {
            background-color: white;
            height: 78dvh;
            border-radius: 1rem;
            padding: 1%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .pos-content {
            width: 100px;
            height: 20px;
            background-color: rgb(231, 231, 231);
            border-radius: .3rem;
            outline: none;
            border: none;
        }

        .word-tag {
            display: inline-block;
            margin-bottom: 20px;
            background-color: white;
            margin-right: 5px;
        }

        .new-tag {
            display: block;
            margin-bottom: 40px;
            background-color: white;
            margin-right: 5px;
        }

        .nn { background-color: yellow; }
        .vb { background-color: green; }
        .dt { background-color:aliceblue; }
        .mdfr { background-color: aquamarine; }
        .pnn { background-color: beige; }
        .cltc { background-color: violet; }
        .nmbr { background-color: tomato; }
        .cjtn { background-color: tan; }
        .ijtn { background-color: purple; }
        .punc { background-color: lavender; }
        .fw { background-color: cyan; }
        .oov { background-color: yellowgreen; }
        .rp { background-color: skyblue;}
        .pstn {background-color: sienna;}
        .ntrg {background-color: sandybrown;}

        .nn, .vb, .dt, .mdfr, .pnn, .cltc, .nmbr, .cjtn,
        .ijtn, .punc, .fw, .oov, .rp, .pstn, .ntrg {
            padding: 1% 1%;
            border: 1px solid black;
            font-style: italic;
        }

        .legends {
            padding: 1%;
            margin-bottom: 20px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h3 class="title">Waray-waray POS Tagger Editor</h3>
        <div class="legends">
            Legends: 
            <b class="nn">Noun</b>
            <b class="dt">Determiners</b>
            <b class="vb">Verb</b>
            <b class="mdfr">Modifier</b>
            <b class="pnn">Pronoun</b>
            <b class="cltc">Clitic</b>
            <b class="nmbr">Cardinal</b>
            <b class="cjtn">Conjuction</b>
            <b class="ijtn">Interjection</b>
            <b class="punc">Punctuation</b>
            <b class="fw">Foreign Word</b>
            <b class="oov">Out Of Vocabulary</b>
            <b class="rp">Particle</b>
            <b class="pstn">Preposition</b>
            <b class="ntrg">Interrogative</b>
        </div>
        <div class="actions">
            <div>
                <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'read' %}">
                    {% csrf_token %}
                    {% for i in file_form %}
                        {{i}}
                    {% endfor %}
                </form>
            </div>
            <div>
                <p>Current File: <b id="current_file"></b></p>
            </div>
            <div>
                <button onclick="download()" id="dl">Download</button>
                <button onclick="saveSever()" style="margin-left: 20px;">Save</button>
            </div>
            <div>
                Select a file:
                <select name="server-file" id="server-file" onchange="changeData()" style="width: 10dvw;">
                    <option selected value="None">---------</option>
                    {% for i in files %}
                        <option value="{{i.id}}">{{i.file}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="pos-tag">
            <div class="pos-data">
                <div class="pos-container">
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function() {
        $('#server-file').select2({
        })
    })
    async function changeData() {
        id = $("#server-file").val()
        if (id !== "None") {
            response = await fetch(`{% url 'readDb'%}?id=${id}`)
            data = await response.json()

            $("#current_file").html(data.filename)
            $(".pos-container").html(data.html)
            toastr.success(`Loaded ${data.filename}!`, "Success")
        }
    }
    function resizeInput(input) {
        input.style.width = (input.value.length + 1) + "ch";
    }

    async function download() {
        var posContainers = document.getElementsByClassName("pos-data")[0].getElementsByClassName("pos-container");
        var csvContent = "Word,Tag\n";
        
        var wordCount = 0
        // Iterate through each pos-container element
        for (var i = 0; i < posContainers.length; i++) {
            var posContainer = posContainers[i];
            var word_data = posContainer.getElementsByClassName("word-tag");
    
            // Iterate through each .word-tag element
            for (var j = 0; j < word_data.length; j++) {
                var wordTag = word_data[j];
                var inputs = wordTag.getElementsByClassName("pos-content");

                var wordValue = inputs[0].value.trim(); //Word
                var tagValue = inputs[1].value.trim();  //Tag

                if (wordValue.trim() !== "") {
                    if (wordValue === ".") {
                        csvContent +=  wordValue + '|' + tagValue + '\n';
                    } else {
                        csvContent += wordValue + '|' + tagValue + ',';
                    }
                    wordCount++
                }
            }
        }
        
        if (+wordCount <= 0) {
            alert("No Data!")
        }
        else {
            return_code = await fetch(`{% url 'download' %}?data=${csvContent}`)
            // Create a Blob containing the CSV content
            var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
        
            // Create a link element to trigger the download
            var a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = 'word_tags.csv';
            
            // Append the link to the body and trigger the click event
            document.body.appendChild(a);
            a.click();
        
            // Clean up
            document.body.removeChild(a);
        }
    }

    function uploadFile() {
        var form = document.getElementById('uploadForm');
        var formData = new FormData(form);

        var csrftoken = getCookie('csrftoken');

        $.ajax({
            type: "POST",
            url: "{% url 'read' %}",
            data : formData,
            processData: false,
            contentType: false,
            dataType : "json",
            headers: {
                "X-CSRFToken": csrftoken
            },
            success: function(response) {
                if (response.code === 200) {
                    $(".pos-container").html(response.html)
                    toastr.success("Uploaded")
                    $("#current_file").html(response.name)
                }   
                else {
                    toastr.error(response.error_data, "Error");
                }
            }
        })
    }
    
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function changeClass(event) {
        var id = event.target.id
        var tag = event.target.value.toLowerCase()
        $(`#${id}`).attr("class", `pos-content ${tag}`)
        if (tag === "?") {
            $(`#${id}`).attr("class", `pos-content punc`)
        }
    }

    async function saveSever() {

        let posContainers1 = document.getElementsByClassName("pos-data")[0].getElementsByClassName("pos-container");
        let csvContent1 = "Word,Tag\n";

        let datas = []
        // Iterate through each pos-container element
        for (var i = 0; i < posContainers1.length; i++) {
            var posContainer1 = posContainers1[i];
            var word_data1 = posContainer1.getElementsByClassName("word-tag");
    
            // Iterate through each .word-tag element
            for (var j = 0; j < word_data1.length; j++) {
                var wordTag1 = word_data1[j];
                var inputs1 = wordTag1.getElementsByClassName("pos-content");

                var wordValue1 = inputs1[0].value.trim(); //Word
                var tagValue1 = inputs1[1].value.trim();  //Tag

                if (wordValue1.trim() !== "") {
                    datas.push({"word" : wordValue1, "tag" : tagValue1})
                }
            }
        }

        if (datas.length === 0) {
            toastr.error("No active file!")
        }

        else {
            toastr.info("Saving!")

            var csrftoken = getCookie('csrftoken');
            file = $("#current_file").html()

            dataTosend = JSON.stringify({data : datas, filename : file})

            return_req = await fetch("{% url 'save'%}", {
                method: "POST",
                headers : {
                    'Content-Type': 'application/json' ,
                    "X-CSRFToken": csrftoken
                },
                body : dataTosend
            })

            return_data = await return_req.json()
            
            if (return_data.code === 200) {
                toastr.success("Save!")
            }
            else {
                toastr.error("Error saving the file!")
            }
        }

    }
    
</script>
</html>